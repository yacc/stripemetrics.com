class SdeImport < Import
  def get_from_stripe
    events = Stripe::Event.all({:count => self.limit, 
                                :type => 'customer.subscription.deleted',
                                :created => {:gte => self.end_at.to_i,:lt => self.start_at.to_i}},
                                self.token)
  end

  def persiste!(events)
    if self.mode == :from_stripe
      events.data.each do |ev|
        cust_id = ev.data.object.customer
        canceled_at = Time.at(ev.created)
        record = ::Customer.where(user_id:user._id).where(stripe_id:cust_id).first_or_create!
        record.update_attributes(canceled_at:canceled_at, created:Time.at(ev.data.object.start), subscription:{canceled_at:canceled_at})
      end
    else
      raise "Importing customer.subscription.deleted events from file is not supported yet"
    end
  end
end

#<Stripe::ListObject:0x81cfc430> JSON: {"object":"list","count":331,"url":"/v1/events","data":[{"id":"evt_1vEuOEFCHyH4Tv","created":1369891026,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1369891025,"status":"canceled","customer":"cus_1vEu6RvsZtygFw","current_period_start":1369891025,"current_period_end":1496120997,"ended_at":1369891026,"trial_start":1369891025,"trial_end":1496120997,"canceled_at":1369891026,"quantity":1}},"object":"event","pending_webhooks":2,"request":"iar_1vEuc8IzowuN4h"},{"id":"evt_1Wsk3Tqfqn7IRn","created":1364273227,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"0:usd:month:7","interval":"month","name":"Sensr Plan usd 0/month","amount":0,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"0:usd:month:7"},"object":"subscription","start":1364272966,"status":"canceled","customer":"cus_1Wsg9Q9wDW6AUH","current_period_start":1364272966,"current_period_end":1490503285,"ended_at":1364273227,"trial_start":1364272966,"trial_end":1490503285,"canceled_at":1364273227,"quantity":1}},"object":"event","pending_webhooks":1,"request":null},{"id":"evt_1WTiYFcA0hSOY6","created":1364180094,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1364180093,"status":"canceled","customer":"cus_1WTinqjInM8ls2","current_period_start":1364180093,"current_period_end":1490410171,"ended_at":1364180094,"trial_start":1364180093,"trial_end":1490410171,"canceled_at":1364180094,"quantity":1}},"object":"event","pending_webhooks":1,"request":null},{"id":"evt_1WTdqHtzHHnkbQ","created":1364179778,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1364179778,"status":"canceled","customer":"cus_1WTddHTcYd7foD","current_period_start":1364179778,"current_period_end":1490409856,"ended_at":1364179778,"trial_start":1364179778,"trial_end":1490409856,"canceled_at":1364179778,"quantity":1}},"object":"event","pending_webhooks":1,"request":null},{"id":"evt_1WN7Lz15RF8WoK","created":1364155528,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1364155527,"status":"canceled","customer":"cus_1WN712NYkSZ9Of","current_period_start":1364155527,"current_period_end":1490385606,"ended_at":1364155528,"trial_start":1364155527,"trial_end":1490385606,"canceled_at":1364155528,"quantity":1}},"object":"event","pending_webhooks":1,"request":null},{"id":"evt_1W5nto19uyL6sa","created":1364091097,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1364091097,"status":"canceled","customer":"cus_1W5nrU8HulpiED","current_period_start":1364091097,"current_period_end":1490321167,"ended_at":1364091097,"trial_start":1364091097,"trial_end":1490321167,"canceled_at":1364091097,"quantity":1}},"object":"event","pending_webhooks":1,"request":null},{"id":"evt_1UC2yRVbk8B4nf","created":1363653068,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1363653065,"status":"canceled","customer":"cus_1UC2AJRXvS1ouW","current_period_start":1363653065,"current_period_end":1489883153,"ended_at":1363653068,"trial_start":1363653065,"trial_end":1489883153,"canceled_at":1363653068,"quantity":1}},"object":"event","pending_webhooks":1,"request":null},{"id":"evt_1UC1sahx1acKBl","created":1363652965,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1363652962,"status":"canceled","customer":"cus_1UC1xjzDcWcTQO","current_period_start":1363652962,"current_period_end":1489883049,"ended_at":1363652965,"trial_start":1363652962,"trial_end":1489883049,"canceled_at":1363652965,"quantity":1}},"object":"event","pending_webhooks":1,"request":null},{"id":"evt_1UAzd8VbMx4lsf","created":1363649153,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1363649150,"status":"canceled","customer":"cus_1UAzju5G7Ntr5x","current_period_start":1363649150,"current_period_end":1489879238,"ended_at":1363649152,"trial_start":1363649150,"trial_end":1489879238,"canceled_at":1363649152,"quantity":1}},"object":"event","pending_webhooks":1,"request":null},{"id":"evt_1UAyOIfAqYC3Wy","created":1363649090,"livemode":false,"type":"customer.subscription.deleted","data":{"object":{"plan":{"id":"995:usd:month:7","interval":"month","name":"Sensr Plan usd 995/month","amount":995,"currency":"usd","object":"plan","livemode":false,"interval_count":1,"trial_period_days":7,"identifier":"995:usd:month:7"},"object":"subscription","start":1363649088,"status":"canceled","customer":"cus_1UAyDh1QKQ1J5g","current_period_start":1363649088,"current_period_end":1489879177,"ended_at":1363649090,"trial_start":1363649088,"trial_end":1489879177,"canceled_at":1363649090,"quantity":1}},"object":"event","pending_webhooks":1,"request":null}]}